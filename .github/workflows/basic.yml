name: Testes qualitativos

on:
  push:
    branches: 
      # - "main"
      - "beta"
      - "test-bash"
  pull_request:
    branches:
      - "main"
      - "beta"

env:
  php-version: 8.1
  psr: PSR12

jobs:
  padrao-de-codigo:
    runs-on: ubuntu-latest

    steps:
    - uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.php-version }}
    - uses: actions/checkout@v3

    - name: Instalar Dependências
      run: composer require squizlabs/php_codesniffer -q --no-interaction --no-progress

    - name: Verificar nivelamento
      run: |
        git fetch --all -p
        COMMITS_BEHIND=$(git rev-list --count --right-only $GITHUB_REF_NAME..origin/main);
        COMMITS_BEHIND=$(git rev-list --count --right-only test-bash..origin/main);

        echo $GITHUB_REF_NAME
        eval $(git rev-list --left-right test-bash..origin/main)
        eval $(git rev-list --left-right $GITHUB_REF_NAME..origin/main)
        

        if [[ $COMMITS_BEHIND -gt 0 ]]; then
            echo "Branch desnivelada à main, $COMMITS_BEHIND commit(s) atrás."
            exit 1;
        fi

    - name: Verificar padrão de código
      run: |
        git fetch --all -p
        git_command="$(which git) diff origin/main $GITHUB_REF_NAME --name-only --diff-filter=d"

        for diff_file in $($git_command); do
          eval "vendor/bin/phpcs --standard=${{ env.psr }} $diff_file";
        done;